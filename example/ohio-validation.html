<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Validating Network - Network Analysis and Data Integration (NADI)</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Network Analysis and Data Integration (NADI)</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="validating-network"><a class="header" href="#validating-network">Validating Network</a></h1>
<div class="warning">
In this example we will use `nadi-gis` plugin to load and write GIS files, while using QGIS to generate the map visualization. The plugin is external, refer to the installation page to install it into the NADI System.
<p>Different from other chapters, the code in this chapters are run in the order they are given, meaning each task code blocks are not independent.</p>
</div>
<h2 id="load-network-and-attributes"><a class="header" href="#load-network-and-attributes">Load Network and Attributes</a></h2>
<p>We’ll use the same network from the Dams count example.</p>
<pre><code class="language-task">network load_file("data/ohio-river/ohio.network")
network count()
network outlet()

node.is_usgs = NAME match "^[0-9]+";
node.is_dam = !is_usgs;
network count(nodes.is_usgs)
network count(nodes.is_dam)
</code></pre>
<p>Results:</p>
<pre><code class="language-output">5987
"03399800"
1806
4181
</code></pre>
<p>Then we load the node attributes from the gis files, we can see some of the variables are loaded from NID website.</p>
<pre><code class="language-task">network gis_load_attrs("data/ohio-river/nid-uniq.gpkg", "nidId")
network gis_load_attrs("data/ohio-river/GageLoc.shp.zip", "SOURCE_FEA")
network gis_load_attrs("data/ohio-river/gages-II.gpkg", "STAID")
network gis_load_attrs("data/ohio-river/usgs-drainage.csv", "SiteNumber")

node[03399800].SiteNumber # only USGS gages have it
node(INDEX &lt; 5).yearCompleted # only NID dams have it
node(INDEX &lt; 5).GEOM # all nodes have it although from different sources
</code></pre>
<p>Results:</p>
<pre><code class="language-output">{
  03399800 = &lt;None&gt;
}
{
  03399800 = &lt;None&gt;,
  IL50499 = 1980,
  IL00070 = 1960,
  IL00955 = 1977,
  IL40055 = 1980
}
{
  03399800 = "POINT (-88.4234349499133 37.1612042742605 0)",
  IL50499 = "POINT (-88.42921894 37.16622664)",
  IL00070 = "POINT (-88.57139 37.21975)",
  IL00955 = "POINT (-88.78582 37.38365)",
  IL40055 = "POINT (-88.77145 37.401709)"
}
</code></pre>
<p>Also note that, while loading GIS files it also loads the geometry into “GEOM” attribute (you can change it through <code>change</code> function argument).</p>
<!-- Let's make them into same format to avoid future problems. -->
<!-- ```task run continue -->
<!-- node(GEOM?).GEOM = str_replace(GEOM, " 0\\)", ")"); -->
<!-- node(INDEX < 5).GEOM -->
<!-- ``` -->
<h2 id="process-attributes"><a class="header" href="#process-attributes">Process Attributes</a></h2>
<p>Since we need a quick and easy way to identify USGS gage and NID dam, we use regex to categorize them.</p>
<pre><code class="language-task">node.is_usgs = NAME match "^[0-9]+";
node.is_dam = !is_usgs;
network count(nodes.is_usgs)
network count(nodes.is_dam)
</code></pre>
<p>Results:</p>
<pre><code class="language-output">1806
4181
</code></pre>
<p>The basin area is stored as different variable in each dataset, we want to combine them into a single one.</p>
<pre><code class="language-task">node.ba = first_attr(["drainageArea", "DRAIN_SQKM", "Drainage"])
network count(nodes.ba?) / count()
</code></pre>
<p>Results:</p>
<pre><code class="language-output">0.7561382996492401
</code></pre>
<p>Even then we only have 75% of the nodes with basin area. Since the <code>DrainageArea</code> is in sqmiles</p>
<p>If we look at some examples here on two sources of basin area of USGS gages, we can see the problems:</p>
<pre><code class="language-task">node(is_usgs &amp; Drainage? &amp; DRAIN_SQKM? &amp; INDEX &lt; 100) array(Drainage, DRAIN_SQKM)
</code></pre>
<p>Results:</p>
<pre><code class="language-output">{
  03384450 = ["42.9", 111.1266],
  03383000 = ["255.0", 660.5415],
  03382100 = ["147.0", 367.272]
}
</code></pre>
<ol>
<li>The <code>Drainage</code> value are <code>String</code>,</li>
<li>The units are different (confirmed from metadata of datasets).</li>
</ol>
<p>So we reconcile that,</p>
<pre><code class="language-task">node(Drainage?).basin_area = float(Drainage);
node(DRAIN_SQKM?).basin_area = DRAIN_SQKM * 0.38610216;
</code></pre>
<p>*Error*:</p>
<pre><code class="language-error">Error in function float: cannot parse float from empty string
</code></pre>
<p>We got an error, seems like <code>Drainage</code> contains empty strings as well. That and the <code>String</code> part comes from loading a CSV without data types (<code>.csvt</code> file).</p>
<p>Let’s fix the code for that, and also let’s get the <code>basin_area</code> for dams.</p>
<pre><code class="language-task">node(Drainage? &amp; Drainage match "[0-9]+(.[0-9]+)?").basin_area = float(Drainage);
node(DRAIN_SQKM?).basin_area = DRAIN_SQKM * 0.38610216;
node(drainageArea?).basin_area = float(drainageArea);

node(INDEX &lt; 10).basin_area
network count(nodes.basin_area?) / count()
</code></pre>
<p>Results:</p>
<pre><code class="language-output">{
  03399800 = &lt;None&gt;,
  IL50499 = 144000,
  IL00070 = &lt;None&gt;,
  IL00955 = &lt;None&gt;,
  IL40055 = 0.08,
  IL00039 = &lt;None&gt;,
  03386500 = 9.853134072120001,
  IL00102 = 2,
  03386000 = &lt;None&gt;,
  03385500 = &lt;None&gt;
}
0.755971271087356
</code></pre>
<h2 id="check-for-incorrect-basin-areas"><a class="header" href="#check-for-incorrect-basin-areas">Check for Incorrect Basin Areas</a></h2>
<p>Now we have all the different variables combined into a single one with same data type and unit. Let’s do a quick analysis to see if there are points in the network where nodes have larger area than input nodes.</p>
<pre><code class="language-task">node.incorrect = basin_area &lt; sum(inputs.basin_area);
network count(nodes.incorrect)
</code></pre>
<p>*Error*:</p>
<pre><code class="language-error">Attribute not found
</code></pre>
<p>The error here comes from the fact that not all nodes contain <code>basin_area</code> attribute. Since <code>basin_area?</code> will only check for the current node, we use a default value when the values are not available into a temporary variable.</p>
<pre><code class="language-task">node.temp_ba = basin_area ? 0.0;
node.incorrect = basin_area? &amp; (basin_area &lt; sum(inputs.temp_ba));
network count(nodes.incorrect)
network count(nodes.incorrect) / count()
</code></pre>
<p>Results:</p>
<pre><code class="language-output">547
0.09136462335059295
</code></pre>
<p>That’s around 10% error rate.</p>
<p>Looking at the actual values, few of them seem to be due to minor errors in values, while most of them seem to be from large input area.</p>
<pre><code class="language-task">node(incorrect &amp; INDEX &lt; 400) array(basin_area, sum(inputs.temp_ba))
</code></pre>
<p>Results:</p>
<pre><code class="language-output">{
  IL00028 = [1.5, 30.036998660096],
  IL50443 = [0.04, 141009.11000000002],
  KY00192 = [0.07, 0.31],
  IN04021 = [0.08, 0.2],
  IN03653 = [0.04, 0.37],
  IL50585 = [0.03, 0.16],
  IL01085 = [240, 240.171142047264],
  IL00606 = [0.6, 57],
  IN00316 = [0.09, 0.15],
  IN00317 = [0.15, 0.7000000000000001],
  IN00319 = [0.7000000000000001, 43.053904369656],
  IN03161 = [0.06, 0.07],
  IN03160 = [0.07, 3.0100000000000002],
  IN04048 = [0.4, 0.53],
  IN00627 = [0.53, 1.1300000000000001],
  IN03433 = [0.03, 1.82],
  IN00617 = [0.27, 0.49],
  IN00480 = [0.56, 21.637975860936002],
  IN00618 = [0.41000000000000003, 1.2700000000000002],
  IN00098 = [0.33, 263.021357392616],
  IN00035 = [0.23, 168.12355234608],
  03343010 = [13732, 13755.171304576803],
  IN00528 = [0.21, 0.32],
  IN00151 = [1.18, 4.75],
  IN03337 = [1.1500000000000001, 42.9097178978],
  IN00107 = [0.55, 8.22],
  IN00209 = [1.8, 8.48],
  IN00091 = [0.6900000000000001, 0.87],
  IN00092 = [0.87, 8.38]
}
</code></pre>
<p>This could be due to the error in snapping to the streamlines. It is also possible that some basin area that are missing are contributing to the unaccounted area.</p>
<p>Let’s try to fix them, or avoid points without data.</p>
<pre><code class="language-task">node.all_inputs_ba = all(inputs.basin_area?);
node.incorrect = basin_area? &amp; all_inputs_ba &amp; (
	basin_area &lt; (0.975 * sum(inputs.basin_area))
);
network count(nodes.incorrect)
network count(nodes.incorrect) / count()
</code></pre>
<p>Results:</p>
<pre><code class="language-output">451
0.07532988140972106
</code></pre>
<p>Looks like 7.5% of the errors are reasonable errors from network detection.</p>
<pre><code class="language-task">network count(nodes.incorrect &amp; nodes.is_usgs)
network count(nodes.incorrect &amp; nodes.is_dam)
</code></pre>
<p>Results:</p>
<pre><code class="language-output">8
443
</code></pre>
<p>This shows that the majority of the errors come from the NID dams, which makes sense given the <code>GageLoc.shp</code> data has points indexed to the NHDPlus streamlines, while the NID Dams are not indexed to it. Furthermore, looking at the attributes in QGIS shows, many dams are in locations without streamlines, and even then sometimes they have unusually large basin area values for their location.</p>
<h2 id="export-to-gis-for-visualization"><a class="header" href="#export-to-gis-for-visualization">Export to GIS for visualization</a></h2>
<p>We can export this result to a GIS file and look into individual cases in QGIS.</p>
<pre><code class="language-task">network gis_save_nodes(
    "output/ohio-gages-check.gpkg",
	"GEOM",
	{
		NAME="String",
		is_usgs="String",
		incorrect="String",
		basin_area="Float"
	}
)
</code></pre>
<p>Results:</p>
<pre><code class="language-output">
</code></pre>
<p>We also need connection information to cross reference, let’s make them through some string manipulation. NADI GIS plugin uses WKT format for geometries, which are string values, so we can manipulate them using string functions.</p>
<p>Note: we should probably add a function for this in future. A WKT plugin to work with geometries.</p>
<pre><code class="language-task">node.xy_coords = str_find_all(node.GEOM, "-?[0-9]+[.][0-9]+");
node(output._?).out_coords = str_find_all(output.GEOM, "-?[0-9]+[.][0-9]+");
node(! output._?).conn_geom = GEOM
node(output._?).conn_geom = env.render(
	"LINESTRING ({_x1} {_y1}, {_x2} {_y2})",
	x1=get(node.xy_coords, 0),
	y1=get(node.xy_coords, 1),
	x2=get(node.out_coords, 0),
	y2=get(node.out_coords, 1)
)
node(output._? &amp; (INDEX &lt; 10)).conn_geom

network gis_save_connections("output/ohio-conn-all.gpkg", "conn_geom")
</code></pre>
<p>Results:</p>
<pre><code class="language-output">{
  IL50499 = "LINESTRING (-88.42921894 37.16622664, -88.4234349499133 37.1612042742605)",
  IL00070 = "LINESTRING (-88.57139 37.21975, -88.42921894 37.16622664)",
  IL00955 = "LINESTRING (-88.78582 37.38365, -88.42921894 37.16622664)",
  IL40055 = "LINESTRING (-88.77145 37.401709, -88.42921894 37.16622664)",
  IL00039 = "LINESTRING (-88.68815 37.38965, -88.42921894 37.16622664)",
  03386500 = "LINESTRING (-88.6736645 37.4156072, -88.68815 37.38965)",
  IL00102 = "LINESTRING (-88.66408 37.41518, -88.6736645 37.4156072)",
  03386000 = "LINESTRING (-88.6637356477429 37.4140878122472, -88.66408 37.41518)",
  03385500 = "LINESTRING (-88.6494395725886 37.4141446558289, -88.6637356477429 37.4140878122472)"
}
</code></pre>
<p>When we visualize the output in QGIS, we can see the nodes where the <code>basin_area</code> are not correct based on the network information.</p>
<p><img src="../images/ohio-correctness-qgis.png" alt="Correctness in QGIS" /></p>
<p>The zoomed in images at the bottom shows some of the reasons:</p>
<ul>
<li>[left] Incorrect Data in database (I think the dam coordinates are wrong on the blue dot with 277 basin area),</li>
<li>[middle &amp; right] Not enough streamlines for smaller details, and</li>
<li>Nearest river detection algorithm problem from not considering river width.</li>
</ul>
<p>The example for the last problem can be seen in the <a href="https://youtu.be/PIGoVnXb7ck?t=770">Video demostration for NADI QGIS Plugin</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../example/ohio-dams-intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../example/ohio-dams.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../example/ohio-dams-intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../example/ohio-dams.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/syntax-highlight.js"></script>



    </div>
    </body>
</html>
